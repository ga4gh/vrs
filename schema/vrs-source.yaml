# VRS uses yaml as the source document for json schema
#
# To convert vrs.yaml to vrs.json:
#   make vrs.json
# You'll probably have to `pip install pyyaml` first.
#
# To watch for changes and update automatically:
#   make watch &

# https://json-schema.org/understanding-json-schema/reference/schema.html
$schema: "http://json-schema.org/draft/2020-12/schema"
title: "GA4GH-VRS-Definitions"
type: object
strict: true

imports:
  gks.core: core-source.yaml

namespaces:
  gks.core: core.json#/$defs/

$defs:
  # VRS definitions are presented top-down.  Everything rolls up to
  # Variation, which is a polymorphic abstraction of many kinds of
  # variation.

  # =============================================================================
  # Kinds of Variation
  # =============================================================================

  ValueObject:
    inherits: gks.core:Entity
    ga4ghDigest:
      keys:
        - type
    description: >-
      An object whose equality is based on value, not identity. All VRS Value Objects
      may have computed digests from the VRS Computed Identifier algorithm.
      See https://en.wikipedia.org/wiki/Value_object for more on Value Objects.
    heritable_properties:
      type:
        type: string
      digest:
        description: A sha512t24u digest created using the VRS Computed Identifier algorithm.
        type: string
        pattern: '[0-9A-Za-z_\-]{32}'
    heritable_required:
      - type

  # TODO: Draft recomposition of Allele as "AlleleMember" plus seq requirement
  # TODO: Explore "typed entity"

  Variation:
    inherits: ValueObject
    description: >-
      A representation of the state of one or more biomolecules.
    oneOf:
      - $ref: "#/$defs/MolecularVariation"
      - $ref: "#/$defs/SystemicVariation"
#      - $ref: "#/$defs/UtilityVariation"

    discriminator:
      propertyName: type

  MolecularVariation:
    inherits: Variation
    description: >-
      A :ref:`variation` on a contiguous molecule.
    oneOf:
      - $ref: "#/$defs/Allele"
      - $ref: "#/$defs/Haplotype"
    discriminator:
      propertyName: type

#  UtilityVariation:
#    inherits: Variation
#    description: >-
#      A collection of :ref:`Variation` subclasses that cannot be
#      constrained to a specific class of biological variation, but
#      are necessary for some applications of VRS.
#    oneOf:
#      - $ref: "#/$defs/Text"
#      - $ref: "#/$defs/VariationSet"
#    discriminator:
#      propertyName: type

  SystemicVariation:
    inherits: Variation
    description: >-
      A Variation of multiple molecules in the context of a system, e.g.
      a genome, sample, or homologous chromosomes.
    oneOf:
      - $ref: "#/$defs/Genotype"
      - $ref: "#/$defs/CopyNumberCount"
      - $ref: "#/$defs/CopyNumberChange"
    discriminator:
      propertyName: type

  # =============================================================================
  # IDENTIFIABLE TYPES
  # Have a `type` and `_id` attribute
  # =============================================================================

  # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  # Molecular Variation

  Allele:
    maturity: Alpha
    ga4ghDigest:
      prefix: VA
      keys:
        - location
        - state
    inherits: MolecularVariation
    description: >-
      The state of a molecule at a :ref:`Location`.
    type: object
    properties:
      type:
        type: string
        const: "Allele"
        default: "Allele"
        description: >-
          MUST be "Allele"
      location:
        oneOf:
          - $ref_curie: gks.core:IRI
          - $ref: "#/$defs/Location"
        description: >-
          The location of the Allele
      state:
        $ref: "#/$defs/SequenceExpression"
        description: >-
          An expression of the sequence state
    required: [ "location", "state" ]

  Haplotype:
    maturity: Alpha
    ga4ghDigest:
      prefix: HT
      keys:
        - members
    inherits: MolecularVariation
    description: >-
      A set of non-overlapping :ref:`Allele` members that co-occur on the same molecule.
    type: "object"
    properties:
      type:
        type: string
        const: "Haplotype"
        default: "Haplotype"
        description: >-
          MUST be "Haplotype"
      members:
        type: array
        ordered: false
        minItems: 2
        uniqueItems: true
        items:
          oneOf:
            - $ref: "#/$defs/Allele"
            - $ref_curie: gks.core:IRI
        description: >-
          List of Alleles, or references to Alleles, that comprise this Haplotype.
    required: [ "members" ]

  # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  # UtilityVariation

#  Text:
#    ga4ghPrefix: VT
#    inherits: UtilityVariation
#    description: >-
#      A free-text definition of variation.
#    type: object
#    properties:
#      type:
#        type: string
#        const: "Text"
#        default: "Text"
#        description: MUST be "Text"
#      definition:
#        type: string
#        description: >-
#          A textual representation of variation not representable by
#          other subclasses of Variation.
#    required: [ "definition" ]
#
#  VariationSet:
#    ga4ghPrefix: VS
#    inherits: UtilityVariation
#    description: >-
#      An unconstrained set of Variation members.
#    type: object
#    properties:
#      type:
#        type: string
#        const: "VariationSet"
#        default: "VariationSet"
#        description: MUST be "VariationSet"
#      members:
#        type: array
#        ordered: false
#        uniqueItems: true
#        items:
#          oneOf:
#            - $ref_curie: gks.core:IRI
#            - $ref: "#/$defs/Variation"
#        description: >-
#          List of Variation objects or identifiers. Attribute is
#          required, but MAY be empty.
#    required: [ "members" ]


  # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  # SystemicVariation

  CopyNumber:
    ga4ghDigest:
      keys:
        - subject
    inherits: SystemicVariation
    description: >-
      A measure of the copies of a :ref:`Location` within a system (e.g. genome, cell, etc.)
    heritable_properties:
      subject:
        oneOf:
          - $ref_curie: gks.core:IRI
          - $ref: "#/$defs/Location"
        description: >-
          A location for which the number of systemic copies is described.
    heritable_required: [ "subject" ]

  CopyNumberCount:
    maturity: Alpha
    ga4ghDigest:
      keys:
        - copies
      prefix: CN
    inherits: CopyNumber
    type: object
    description: >-
      The absolute count of discrete copies of a :ref:`Location` or :ref:`Gene`,
      within a system (e.g. genome, cell, etc.).
    properties:
      type:
        type: string
        const: "CopyNumberCount"
        default: "CopyNumberCount"
        description: >-
          MUST be "CopyNumberCount"
      copies:
        oneOf:
          - type: integer
          - $ref: "#/$defs/Range"
        description: >-
          The integral number of copies of the subject in a system
    required: [ "copies" ]

  CopyNumberChange:
    maturity: Alpha
    ga4ghDigest:
      keys:
        - copy_change
      prefix: CX
    inherits: CopyNumber
    type: object
    description: >-
      An assessment of the copy number of a :ref:`Location` or a :ref:`Gene` within a system (e.g. genome, cell,
      etc.) relative to a baseline ploidy.
    properties:
      type:
        type: string
        const: "CopyNumberChange"
        default: "CopyNumberChange"
        description: >-
          MUST be "CopyNumberChange"
      copy_change:
        type: string
        enum: [ "efo:0030069", "efo:0020073", "efo:0030068", "efo:0030067", "efo:0030064", "efo:0030070", "efo:0030071", "efo:0030072" ]
        description: >-
          MUST be one of "efo:0030069" (complete genomic loss), "efo:0020073" (high-level loss),
          "efo:0030068" (low-level loss), "efo:0030067" (loss), "efo:0030064" (regional base ploidy),
          "efo:0030070" (gain), "efo:0030071" (low-level gain), "efo:0030072" (high-level gain).
    required: [ "copy_change" ]

  Genotype:
    maturity: Alpha
    ga4ghDigest:
      keys:
        - members
        - count
      prefix: GT
    inherits: SystemicVariation
    description: >-
      A quantified set of _in-trans_ :ref:`MolecularVariation` at a genomic locus.
    type: object
    properties:
      type:
        type: string
        const: "Genotype"
        default: "Genotype"
        description: >-
          MUST be "Genotype"
      members:
        type: array
        ordered: false
        uniqueItems: true
        minItems: 1
        items:
          $ref: "#/$defs/GenotypeMember"
        description: >-
          Each GenotypeMember in `members` describes a :ref:`MolecularVariation`
          and the count of that variation at the locus.
      count:
        oneOf:
          - type: integer
          - $ref: "#/$defs/Range"
        description: >-
          The total number of copies of all :ref:`MolecularVariation` at this locus,
          MUST be greater than or equal to the sum of :ref:`GenotypeMember` copy counts.
          If greater than the total counts, this implies additional
          :ref:`MolecularVariation` that are expected to exist but are not explicitly
          indicated.
    required: [ "members", "count" ]

  # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  # Locations

  Location:
    inherits: ValueObject
    description: >-
      A contiguous segment of a biological sequence.
    oneOf:
#      - $ref: "#/$defs/ChromosomeLocation"
      - $ref: "#/$defs/SequenceLocation"
    discriminator:
      propertyName: type

#  ChromosomeLocation:
#    ga4ghPrefix: CL
#    inherits: Location
#    description: >-
#      A Location on a chromosome defined by a species and chromosome name.
#    type: object
#    properties:
#      type:
#        type: string
#        const: "ChromosomeLocation"
#        default: "ChromosomeLocation"
#        description: MUST be "ChromosomeLocation"
#      species_id:
#        $ref_curie: gks.core:IRI
#        default: "taxonomy:9606"
#        description: >-
#          :ref:`CURIE` representing a species from the
#          `NCBI species taxonomy <https://registry.identifiers.org/registry/taxonomy>`_.
#          Default: "taxonomy:9606" (human)
#      chr:
#        type: string
#        description: >-
#          The symbolic chromosome name. For humans, For humans,
#          chromosome names MUST be one of 1..22, X, Y (case-sensitive)
#      start:
#        $ref: "#/$defs/HumanCytoband"
#        description: >-
#          The start cytoband region. MUST specify a region nearer the
#          terminal end (telomere) of the chromosome p-arm than `end`.
#      end:
#        $ref: "#/$defs/HumanCytoband"
#        description: >-
#          The start cytoband region. MUST specify a region nearer the
#          terminal end (telomere) of the chromosome q-arm than `start`.
#    required: [ "species_id", "chr", "start", "end" ]

  SequenceLocation:
    maturity: Alpha
    ga4ghDigest:
      keys:
        - members
        - count
      prefix: SL
    inherits: Location
    description: >-
      A :ref:`Location` defined by an interval on a referenced :ref:`Sequence`.
    type: object
    properties:
      type:
        type: string
        const: "SequenceLocation"
        default: "SequenceLocation"
        description: MUST be "SequenceLocation"
      sequence:
        oneOf:
          - $ref_curie: gks.core:IRI
          - $ref: "#/$defs/SequenceReference"
        description: >-
          A :ref:`SequenceReference`.
      start:
        oneOf:
          - type: integer
          - $ref: "#/$defs/Range"
        description: >-
          The start coordinate or range of the SequenceLocation.
          The minimum value of this coordinate or range is 0.
          MUST represent a coordinate or range less than the value of `end`.
      end:
        oneOf:
          - type: integer
          - $ref: "#/$defs/Range"
        description: >-
          The end coordinate or range of the SequenceLocation.
          The minimum value of this coordinate or range is 0.
          MUST represent a coordinate or range greater than the value of `start`.
    required: [ "start", "end" ]

  SequenceReference:
    maturity: Alpha
    inherits: ValueObject
    ga4ghDigest:
      prefix: SQR
      keys:
        - refgetAccession
    type: object
    description: A sequence of nucleic or amino acid character codes.
    properties:
      type:
        type: string
        const: "Sequence"
        default: "Sequence"
        description: MUST be "Sequence"
      refgetAccession:
        description: A `GA4GH RefGet <http://samtools.github.io/hts-specs/refget.html>` identifier for the referenced sequence, using the sha512t24u digest.
        type: string
        pattern: 'SQ.[0-9A-Za-z_\-]{32}'
      residueAlphabet:
        type: string
        enum:
          - amino acid
          - nucleic acid

      #TODO: add VRSATILE
      #TODO: implementation guidance: digest property is RefGet TRUNC512

  # =============================================================================
  # NON-IDENTIFIABLE TYPES
  # These types have a `type` attribute
  # =============================================================================

  # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  # SequenceExpression

  SequenceExpression:
    inherits: gks.core:Entity
    description: >-
      An expression describing a :ref:`Sequence`.
    oneOf:
      - $ref: "#/$defs/LiteralSequenceExpression"
      - $ref: "#/$defs/ReferenceLengthExpression"
#      - $ref: "#/$defs/DerivedSequenceExpression"
#      - $ref: "#/$defs/RepeatedSequenceExpression"
#      - $ref: "#/$defs/ComposedSequenceExpression"
    discriminator:
      propertyName: type
    heritable_properties:
      type:
        type: string
        description: >-
          The SequenceExpression class type. MUST match child class type.
    heritable_required:
      - type

  ReferenceLengthExpression:
    maturity: Alpha
    inherits: SequenceExpression
    description: >-
      An expression of a length of a sequence from a repeating reference.
    type: object
    properties:
      type:
        type: string
        const: "ReferenceLengthExpression"
        default: "ReferenceLengthExpression"
        description: MUST be "ReferenceLengthExpression"
      length:
        oneOf:
          - type: integer
          - $ref: "#/$defs/Range"
        description: >-
          The number of residues in the expressed sequence.
      sequence:
        $ref: "#/$defs/SequenceString"
        description: the :ref:`Sequence` encoded by the Reference Length Expression.
      repeatSubunitLength:
        type: integer
        description: >-
          The number of residues in the repeat subunit.
    required:
      - length

  LiteralSequenceExpression:
    maturity: Alpha
    inherits: SequenceExpression
    description: >-
      An explicit expression of a Sequence.
    type: object
    properties:
      type:
        type: string
        const: "LiteralSequenceExpression"
        default: "LiteralSequenceExpression"
        description: MUST be "LiteralSequenceExpression"
      sequence:
        $ref: "#/$defs/SequenceString"
        description: the literal sequence
    required:
      - sequence

#  DerivedSequenceExpression:
#    inherits: SequenceExpression
#    description: >-
#      An approximate expression of a sequence that is derived from
#      a referenced sequence location. Use of this class
#      indicates that the derived sequence is *approximately equivalent*
#      to the reference indicated, and is typically used for describing
#      large regions in contexts where the use of an approximate sequence
#      is inconsequential.
#    type: object
#    properties:
#      type:
#        type: string
#        const: "DerivedSequenceExpression"
#        default: "DerivedSequenceExpression"
#        description: MUST be "DerivedSequenceExpression"
#      location:
#        $ref: "#/$defs/SequenceLocation"
#        description: >-
#          The location from which the approximate sequence is derived
#      reverse_complement:
#        type: boolean
#        description: >-
#          A flag indicating if the expressed sequence is the reverse
#          complement of the sequence referred to by `location`
#    required: [ "location", "reverse_complement" ]
#
#  RepeatedSequenceExpression:
#    inherits: SequenceExpression
#    description: >-
#      An expression of a sequence comprised of a tandem repeating subsequence.
#    type: object
#    properties:
#      type:
#        type: string
#        const: "RepeatedSequenceExpression"
#        default: "RepeatedSequenceExpression"
#        description: MUST be "RepeatedSequenceExpression"
#      seq_expr:
#        oneOf:
#          - $ref: "#/$defs/LiteralSequenceExpression"
#          - $ref: "#/$defs/DerivedSequenceExpression"
#        description: >-
#          An expression of the repeating subsequence
#      count:
#        oneOf:
#          - $ref: "#/$defs/Number"
#          - $ref: "#/$defs/IndefiniteRange"
#          - $ref: "#/$defs/DefiniteRange"
#        description: >-
#          The count of repeated units, as an integer or inclusive range
#    allOf:
#      - if:
#          properties:
#            count:
#              $ref: "#/$defs/Number"
#        then:
#          properties:
#            count:
#              properties:
#                value:
#                  minimum: 0
#      - if:
#          properties:
#            count:
#              $ref: "#/$defs/IndefiniteRange"
#        then:
#          properties:
#            count:
#              properties:
#                value:
#                  minimum: 0
#      - if:
#          properties:
#            count:
#              $ref: "#/$defs/DefiniteRange"
#        then:
#          properties:
#            count:
#              properties:
#                min:
#                  minimum: 0
#                max:
#                  minimum: 0
#    required: [ "seq_expr", "count" ]
#
#  ComposedSequenceExpression:
#    description: >-
#      An expression of a sequence composed from multiple other
#      :ref:`Sequence Expressions<SequenceExpression>`
#      objects. MUST have at least one component that is not a
#      ref:`LiteralSequenceExpression`. CANNOT be composed from
#      nested composed sequence expressions.
#    additionalProperties: false
#    type: object
#    properties:
#      type:
#        type: string
#        const: "ComposedSequenceExpression"
#        default: "ComposedSequenceExpression"
#        description: MUST be "ComposedSequenceExpression"
#      components:
#        type: array
#        ordered: true
#        uniqueItems: true
#        minItems: 2
#        items:
#          anyOf:
#            - $ref: "#/$defs/LiteralSequenceExpression"
#            - $ref: "#/$defs/RepeatedSequenceExpression"
#            - $ref: "#/$defs/DerivedSequenceExpression"
#        description: >-
#          An ordered list of :ref:`SequenceExpression` components
#          comprising the expression. MUST NOT have two adjacent
#          :ref:`LiteralSequenceExpression` objects.
#    required: [ "components" ]

  # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  # Nested Classes

#  HaplotypeMember:
#    inherits: gks.core:Entity
#    description: >-
#      A class for compact representation of :ref:`Allele` members in the context of a :ref:`Haplotype`.
#    type: object

  GenotypeMember:
    privateTo: Genotype
    inherits: gks.core:Entity
    description: >-
      A class for expressing the count of a specific :ref:`MolecularVariation` present
      _in-trans_ at a genomic locus represented by a :ref:`Genotype`.
    type: object
    properties:
      type:
        type: string
        const: "GenotypeMember"
        default: "GenotypeMember"
        description: MUST be "GenotypeMember".
      count:
        oneOf:
          - $ref: '#/$defs/Range'
          - type: integer
        description: >-
          The number of copies of the `variation` at a :ref:`Genotype` locus.
      variation:
        oneOf:
          - $ref: "#/$defs/Allele"
          - $ref: "#/$defs/Haplotype"
        description: >-
          A :ref:`MolecularVariation` at a :ref:`Genotype` locus.
    required: [ "count", "variation" ]

  # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  # Numerics, Comparators, and Ranges

  Range:
    maturity: Alpha
    description: An inclusive range of values bounded by one or more integers.
    type: array
    ordered: true
    items:
      oneOf:
        - type: integer
        - type: 'null'
    maxItems: 2
    minItems: 2

#  Number:
#    description: >-
#      A simple integer value as a VRS class.
#    type: object
#    properties:
#      type:
#        type: string
#        const: "Number"
#        default: "Number"
#        description: MUST be "Number"
#      value:
#        type: integer
#        description: The value represented by Number
#    required: [ "type", "value" ]
#
#  DefiniteRange:
#    description: >-
#      A bounded, inclusive range of numbers.
#    type: object
#    properties:
#      type:
#        type: string
#        const: "DefiniteRange"
#        default: "DefiniteRange"
#        description: MUST be "DefiniteRange"
#      min:
#        type: number
#        description: The minimum value; inclusive
#      max:
#        type: number
#        description: The maximum value; inclusive
#    required: ["type", "min", "max"]
#
#  IndefiniteRange:
#    description: >-
#      A half-bounded range of numbers represented as a number bound and
#      associated comparator. The bound operator is interpreted as follows:
#      '>=' are all numbers greater than and including `value`, '<=' are all
#      numbers less than and including `value`.
#    type: object
#    properties:
#      type:
#        type: string
#        const: "IndefiniteRange"
#        default: "IndefiniteRange"
#        description: MUST be "IndefiniteRange"
#      value:
#        type: number
#        description: The bounded value; inclusive
#      comparator:
#        type: string
#        enum: [ "<=", ">=" ]
#        description: >-
#          MUST be one of "<=" or ">=", indicating which direction the range
#          is indefinite
#    required: [ "type", "value", "comparator" ]

  # =============================================================================
  # BASIC TYPES (STRUCTURES)
  # These types do NOT have a VRS `type` attribute
  # These types are used solely within other definitions.
  # =============================================================================

#  HumanCytoband:
#    description: >-
#      A character string representing cytobands derived from the
#      *International System for Human Cytogenomic Nomenclature* (ISCN)
#      `guidelines <http://doi.org/10.1159/isbn.978-3-318-06861-0>`_.
#    type: string
#    pattern: '^cen|[pq](ter|([1-9][0-9]*(\.[1-9][0-9]*)?))$'
#    example: "q22.3"

  Residue:
    maturity: Alpha
    description: >-
      A character representing a specific residue (i.e., molecular species)
      or groupings of these ("ambiguity codes"), using `one-letter IUPAC
      abbreviations <https://en.wikipedia.org/wiki/International_Union_of_Pure_and_Applied_Chemistry#Amino_acid_and_nucleotide_base_codes>`_
      for nucleic acids and amino acids.
    type: string
    pattern: '[A-Z*\-]'

  SequenceString:
    maturity: Alpha
    description: >-
      A character string of :ref:`Residues <Residue>` that represents a biological
      sequence using the conventional sequence order (5’-to-3’ for
      nucleic acid sequences, and amino-to-carboxyl for amino acid
      sequences). IUPAC ambiguity codes are permitted in Sequence Strings.
    type: string
    pattern: '^[A-Z*\-]*$'
